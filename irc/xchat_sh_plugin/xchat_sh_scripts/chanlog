. irc.shlib
. irccols.shlib

## DONE: ping timeouts fixed; getnumber previously only accepted streams, but now it accepts arguments too

if [ "$1" = --help ]
then
	echo "See channel history with: !chanlog [-all] [<num_lines>] [#<channel>] [<search_string>]"
	exit 0
fi

if [ "$1" = -all ]
then CHANLOG_SHOW_ALL=true; shift
fi

(

	LOGDIR="$HOME/.xchat2/xchatlogs"
	# LOGDIR="$HOME/.xchat2.nogginBasher/xchatlogs" ## TODO: auto-find this from xchat vars?!

	# LINES=5
	# if [ "$1" = -n ]
	# then
		# shift
	if [ "$1" ] ## we must not run getnumber "", it blocks!!
	then LINES=`getnumber "$1" | sed 's+\..*$++'`
	fi
	[ "$LINES" ] && shift || LINES=5
	# fi
	# [ "$LINES" -gt 10 ] && LINES=10 && echo "Max 10 lines sorry. :P"
	if [ "$LINES" -gt 25 ]
	# then LINES=25 ; echo "Max 25 lines sorry. :P"
	then LINES=25 ; echo "Sorry, I will repeat max last 25 lines only. :P"
	fi

	if [ "$1" ] && startswith "$1" "#"
	then SEARCH_CHANNEL="$1" ; shift
	else SEARCH_CHANNEL="$CHANNEL"
	fi

	if [ "$SEARCH_CHANNEL" ] && contains "$SEARCH_CHANNEL" "priv" && [ ! "$CHANNEL" = "$SEARCH_CHANNEL" ]
	then
		echo "Refusing to repeat log for private channel [$SEARCH_CHANNEL]."
		exit 0
	fi

	if [ "$SEARCH_CHANNEL" ] && ! startswith "$SEARCH_CHANNEL" "#"
	then
		echo "Refusing to repeat log for private message [$SEARCH_CHANNEL]."
		exit 0
	fi

	## DONE: still a bit worried that $GREP_EXPR could be misused, e.g. -C2 and grep will still expect another argument :O
	##       ok now we escape any leading - in $GREP_EXPR as \- but still
	## DONE: can grep be abused in other ways? :O  I guess not, since the $GREP_EXPR can *only* be interpreted as an expression :P  Yes it can, if GREP_EXPR="[" then the regexp fails, and although running chanlog from the shell will not block, running it from IRC will cause the b0t to ping timeout =/
	##       ok so now we use toregexp to avoid this problem

	# GREP_EXPR="$*" ## or empty if no remaining args :)
	GREP_EXPR="`toregexp "$*"`" ## or empty if no remaining args :)

	if startswith "$GREP_EXPR" -
	then GREP_EXPR="\\$GREP_EXPR"
	fi

	## XChat will sometimes log a file as NETWORK-#<channel> instead of <network>-#<channel>
	## We look for both, and sort by last-modified date
	## This is still not perfect, since we should ideally mesh the lines from both files, ordered by the date of each line
	## Also not ideal: we do not jzcat any old compressed logfiles
	# FILES="`
		# for NICENET in NETWORK QuakeNet xyxyx.org
		# do
			# POSSFILE="$LOGDIR/$NICENET-$SEARCH_CHANNEL.log"
			# [ -f "$POSSFILE" ] && echo "$POSSFILE"
		# done |
		# sortfilesbydate
	# `"
	FILES=` echolines "$LOGDIR"/*-"$SEARCH_CHANNEL".log | sortfilesbydate | cat `

	# jshinfo "FILES = $FILES"

	# NETWORK="QuakeNet"
	# NETWORK="NETWORK"
	# LOGFILE="$LOGDIR/$NETWORK-$SEARCH_CHANNEL.log"
	# OTHERLOGFILE="$LOGDIR/NETWORK-$SEARCH_CHANNEL.log"
	# [ -f "$LOGFILE" ] && [ -f "$OTHERLOGFILE" ] && newer "$OTHERLOGFILE" "$LOGFILE" && LOGFILE="$OTHERLOGFILE"
	# [ -f "$LOGFILE" ] || LOGFILE="$OTHERLOGFILE"

	if [ ! "$FILES" ] || [ "$FILES" = . ] ## the check for . is to deal with a bug from sortfilesbydate
	then echo "$COLYELLOW""Sorry, I couldn't find any suitable logfiles matching \"$SEARCH_CHANNEL\".$COLRESET" # the logfile $NETWORK-$SEARCH_CHANNEL.log"
	else
		# echo "From file `filename "$LOGFILE"`:"
		# cat "$LOGFILE" |
		# echo "Here is last of $SEARCH_CHANNEL :"
		ALSO=
		[ "$GREP_EXPR" ] && ALSO=" matching \"$GREP_EXPR\""
		SHOWFILES=`echo "$FILES" | afterlast / | tr '\n' ' ' | sed 's+ $++'`
		echo "Here is last of $SHOWFILES$ALSO:"
		echo "$FILES" | withalldo cat |
		## Strip joins, parts, and operations:
		if [ "$CHANLOG_SHOW_ALL" ]
		then cat
		else
			grep -v "\---" |
			grep -v "<--" |
			grep -v "\-->"
		fi |
		grep -v "^[^ ]* [^ ]* [^ ]* >" | ## Strip notices (e.g. those generated by chanlog!)
		if [ "$GREP_EXPR" ]
		then
			grep -i "$GREP_EXPR" | ## had no quotes before, but feared that might let people grep my files
			sed " s+^+$COLGREY+ ; s$GREP_EXPR$COLYELLOW""\0""$COLGREYig "
		else
			cat
		fi |
		tail -n "$LINES" |
		grep . || echo "No matching lines found."
	fi

) | NOTICE_STYLE=notice notice

