## TODO: support for POST requests

getcgi() {
	TESTRES=`echo "$QUERY_STRING" | sed "s/.*\(^\|&\|'\)$1=\([^&']*\)\($\|&\|'\).*/\2/"`
	if [ "$TESTRES" = "$QUERY_STRING" ]
	then echo "cglib.getcgi(): Error finding var >$1<" > /dev/stderr
	else echo "$TESTRES" | fromcgi
	fi
}

## Note: In order to use serve you will want to import cgilib after setting CGILIB_NO_CONTENT
## It doesn't return the file properly (wrong name, no mimetype), but it does return it!
serve() {
	FILE="$1"
	FILENAME=`basename "$FILE"`
	# file --mime "$FILE"
	MIMETYPE=`file --mime "$FILE" | sed 's+.*:.++'`
	echo "Content-type: $MIMETYPE"
	# Untested:
	echo "Content-length: "`ls -ld "$FILE" | awk ' { print $5 } '`
	echo "Content-Disposition: attachment; filename=\"$FILENAME\""
	echo
	cat "$FILE"
}

starthtml() {
	TITLE="$1" ## TODO: htmlencode!
	echo "<HTML><HEAD><TITLE>$TITLE</TITLE></HEAD><BODY>"
}

endhtml() {
	echo "</BODY></HTML>"
}

simpleresponseheader() {
	echo "Content-type: $CGILIB_CONTENT_TYPE"
	echo
}

if [ ! $CGILIB_NO_CONTENT ]
then
	if [ ! $CGILIB_CONTENT_TYPE ]
	then CGILIB_CONTENT_TYPE="text/html"
	fi
	simpleresponseheader
fi

fromcgi () {
## BUG TODO: We seem to be losing real '+'s into ' 's, but don't know how!
##           Oh well I think I've fixed it by removing the /+/ / below (at least it works when using getcgi (in revssh))
# CGICONV=`/home/joey/j/code/shellscript/hugswrap/ascii.sh`
# echo $CGICONV >&2
sed '
## Ones I found, lots more needed here!
# s/+/ /g;
s/%20/ /g;
s/%2[Ff]/\//g;
s/%3[Aa]/:/g;
s/%40/@/g;
## Newlines:
s/%0[Dd]%0[Aa]/\
/g;s/%0[Dd]/\
/g;s/%0[Aa]/\
/g
## The rest were generated by ascii.sh,
## a few of the following replacements were regexp escaped by hand,
## and the [cC]s (for case-insensitivity) were generated by a vim macro:
s/%01//g
s/%02//g
s/%03//g
s/%04//g
s/%05//g
s/%06//g
s/%07//g
s/%08//g
s/%09/	/g
s/%0[bB]//g
s/%0[cC]//g
s/%0[dD]//g
s/%0[eE]//g
s/%0[fF]//g
s/%10//g
s/%11//g
s/%12//g
s/%13//g
s/%14//g
s/%15//g
s/%16//g
s/%17//g
s/%18//g
s/%19//g
s/%1[aA]//g
s/%1[bB]//g
s/%1[cC]//g
s/%1[dD]//g
s/%1[eE]//g
s/%1[fF]//g
s/%20/ /g
s/%21/!/g
s/%22/"/g
s/%23/#/g
s/%24/$/g
s/%25/%/g
s/%26/&/g
s/%27/'"'"'/g
s/%28/\(/g
s/%29/\)/g
s/%2[aA]/*/g
s/%2[bB]/+/g
s/%2[cC]/,/g
s/%2[dD]/-/g
s/%2[eE]/./g
s/%2[fF]/\//g
s/%30/0/g
s/%31/1/g
s/%32/2/g
s/%33/3/g
s/%34/4/g
s/%35/5/g
s/%36/6/g
s/%37/7/g
s/%38/8/g
s/%39/9/g
s/%3[aA]/:/g
s/%3[bB]/;/g
s/%3[cC]/</g
s/%3[dD]/=/g
s/%3[eE]/>/g
s/%3[fF]/?/g
s/%40/@/g
s/%41/A/g
s/%42/B/g
s/%43/C/g
s/%44/D/g
s/%45/E/g
s/%46/F/g
s/%47/G/g
s/%48/H/g
s/%49/I/g
s/%4[aA]/J/g
s/%4[bB]/K/g
s/%4[cC]/L/g
s/%4[dD]/M/g
s/%4[eE]/N/g
s/%4[fF]/O/g
s/%50/P/g
s/%51/Q/g
s/%52/R/g
s/%53/S/g
s/%54/T/g
s/%55/U/g
s/%56/V/g
s/%57/W/g
s/%58/X/g
s/%59/Y/g
s/%5[aA]/Z/g
s/%5[bB]/\[/g
s/%5[cC]/\\/g
s/%5[dD]/\]/g
s/%5[eE]/^/g
s/%5[fF]/_/g
s/%60/\`/g
s/%61/a/g
s/%62/b/g
s/%63/c/g
s/%64/d/g
s/%65/e/g
s/%66/f/g
s/%67/g/g
s/%68/h/g
s/%69/i/g
s/%6[aA]/j/g
s/%6[bB]/k/g
s/%6[cC]/l/g
s/%6[dD]/m/g
s/%6[eE]/n/g
s/%6[fF]/o/g
s/%70/p/g
s/%71/q/g
s/%72/r/g
s/%73/s/g
s/%74/t/g
s/%75/u/g
s/%76/v/g
s/%77/w/g
s/%78/x/g
s/%79/y/g
s/%7[aA]/z/g
s/%7[bB]/{/g
s/%7[cC]/|/g
s/%7[dD]/}/g
s/%7[eE]/~/g
s/%7[fF]//g
s/%80/Ä/g
s/%81/Å/g
s/%82/Ç/g
s/%83/É/g
s/%84/Ñ/g
s/%85/Ö/g
s/%86/Ü/g
s/%87/á/g
s/%88/à/g
s/%89/â/g
s/%8[aA]/ä/g
s/%8[bB]/ã/g
s/%8[cC]/å/g
s/%8[dD]/ç/g
s/%8[eE]/é/g
s/%8[fF]/è/g
s/%90/ê/g
s/%91/ë/g
s/%92/í/g
s/%93/ì/g
s/%94/î/g
s/%95/ï/g
s/%96/ñ/g
s/%97/ó/g
s/%98/ò/g
s/%99/ô/g
s/%9[aA]/ö/g
s/%9[bB]/õ/g
s/%9[cC]/ú/g
s/%9[dD]/ù/g
s/%9[eE]/û/g
s/%9[fF]/ü/g
s/%a0/†/g
s/%a1/°/g
s/%a2/¢/g
s/%a3/£/g
s/%a4/§/g
s/%a5/•/g
s/%a6/¶/g
s/%a7/ß/g
s/%a8/®/g
s/%a9/©/g
s/%a[aA]/™/g
s/%a[bB]/´/g
s/%a[cC]/¨/g
s/%a[dD]/≠/g
s/%a[eE]/Æ/g
s/%a[fF]/Ø/g
s/%b0/∞/g
s/%b1/±/g
s/%b2/≤/g
s/%b3/≥/g
s/%b4/¥/g
s/%b5/µ/g
s/%b6/∂/g
s/%b7/∑/g
s/%b8/∏/g
s/%b9/π/g
s/%b[aA]/∫/g
s/%b[bB]/ª/g
s/%b[cC]/º/g
s/%b[dD]/Ω/g
s/%b[eE]/æ/g
s/%b[fF]/ø/g
s/%c0/¿/g
s/%c1/¡/g
s/%c2/¬/g
s/%c3/√/g
s/%c4/ƒ/g
s/%c5/≈/g
s/%c6/∆/g
s/%c7/«/g
s/%c8/»/g
s/%c9/…/g
s/%c[aA]/ /g
s/%c[bB]/À/g
s/%c[cC]/Ã/g
s/%c[dD]/Õ/g
s/%c[eE]/Œ/g
s/%c[fF]/œ/g
s/%d0/–/g
s/%d1/—/g
s/%d2/“/g
s/%d3/”/g
s/%d4/‘/g
s/%d5/’/g
s/%d6/÷/g
s/%d7/◊/g
s/%d8/ÿ/g
s/%d9/Ÿ/g
s/%d[aA]/⁄/g
s/%d[bB]/€/g
s/%d[cC]/‹/g
s/%d[dD]/›/g
s/%d[eE]/ﬁ/g
s/%d[fF]/ﬂ/g
s/%e0/‡/g
s/%e1/·/g
s/%e2/‚/g
s/%e3/„/g
s/%e4/‰/g
s/%e5/Â/g
s/%e6/Ê/g
s/%e7/Á/g
s/%e8/Ë/g
s/%e9/È/g
s/%e[aA]/Í/g
s/%e[bB]/Î/g
s/%e[cC]/Ï/g
s/%e[dD]/Ì/g
s/%e[eE]/Ó/g
s/%e[fF]/Ô/g
s/%f0//g
s/%f1/Ò/g
s/%f2/Ú/g
s/%f3/Û/g
s/%f4/Ù/g
s/%f5/ı/g
s/%f6/ˆ/g
s/%f7/˜/g
s/%f8/¯/g
s/%f9/˘/g
s/%f[aA]/˙/g
s/%f[bB]/˚/g
s/%f[cC]/¸/g
s/%f[dD]/˝/g
s/%f[eE]/˛/g
s/%f[fF]/ˇ/g
'
}
