#!/bin/sh

. cgilib
# export JPATH=/home/joey/j
# . /home/joey/j/startj-simple

SESSID=`getcgi "sessid"`
INIT=`getcgi "init"`
CHECKHOST=`getcgi "checkhost"`

if [ "$CHECKHOST" ]
then

	CHECKFILE="/tmp/revssh-host-$CHECKHOST"
	if [ -f "$CHECKFILE".on ]
	then echo "yes please init"
	else
		echo "no"
		echo -e "touch $CHECKFILE.on\nto accept revssh sessions from $CHECKHOST" > "$CHECKFILE.off"
	fi

elif [ "$INIT" = true ]
then

	echo "" > /tmp/revssh-client-input-$SESSID.txt
	echo "" > /tmp/revssh-client-output-$SESSID.txt
	chmod ugo+w /tmp/revssh-client-input-$SESSID.txt
	chmod ugo+r /tmp/revssh-client-output-$SESSID.txt
	# echo 'echo "Connexion established"'
	tail -f /tmp/revssh-client-input-$SESSID.txt

else

	OUTPUT=`getcgi "output"`

	echo "$OUTPUT" >> /tmp/revssh-client-output-$SESSID.txt

fi
