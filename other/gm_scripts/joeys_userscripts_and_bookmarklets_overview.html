<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
"http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
 <HEAD>
  <TITLE>Joey&apos;s Userscripts and Bookmarklets Overview</TITLE>
 <META NAME="generator", CONTENT="mod_autoindex"> </HEAD>
 <BODY bgcolor="#ffffff" text="#000000">
	 <script type="text/javascript">

var generalHTML = "<center><h1>Joey's Userscripts and Bookmarklets Overview</h1></center>";

if (navigator.appVersion.match(/Chrome/)) {
	generalHTML += '<center><p style="width:50%; background-color: #ffeecc; padding: 4px;"><small>Google Chrome / Chromium users: Recent versions of Chrome will now only install addons from the Chrome Web Store.  To install userscripts from sites such as this one, you may need to pass <code>--enable-easy-off-store-extension-install</code> as a command-line parameter.  Or you could install the <a href="http://www.chromeextensions.org/appearance-functioning/tampermonkey">TamperMonkey extension</a> (which also provides cross-domain GM_xmlHttpRequest).</small></p></center>';
}

generalHTML += "<div style='padding: 0px 10%;'>";
generalHTML += "<p>This is a list of my favourite userscripts, along with Bookmarklets to run them on-demand.  The bookmarklets also load <tt>FallbackGMAPI.user.js</tt>, so that calls to <tt>GM_</tt> functions from userscripts will not fail.</p>";
generalHTML += "<p>Hover over an Install Userscript link to see its description and source code.  Sorry there are no self-contained bookmarklets at this time.  I will happily accept code that builds them from XHRs!";
generalHTML += "<p>This page is generated by an XHR request to an Apache listing, and then augmented by <tt>make_bookmarklet_from_us.user.js</tt> and <tt>Convert_Dates_to_Ages.user.js</tt> .</p>";
generalHTML += "<p><small>(Note that bookmarklets on this page are simple wrappers that load the script at runtime from my server, so you have to trust I won't inject dodgy code into them tomorrow!  They may also break while I'm developing them, or disappear if I get hit by a bus.  But the advantage is that you never need to update.  This approach is very useful for bookmarklet development.)</small></p>";
generalHTML += "<p>Related pages: <a href='http://userscripts.org/users/89794/scripts?sort=fans'>My scripts on userscripts.org</a> | <a href='http://hwi.ath.cx/joeys_bookmarklets.html'>My Bookmarklet Development Page</a> </p>";
generalHTML += "</div>";

generalHTML += "<a target='skip_intro'></a>";   // Not much use, since it loads too late!
if (document.location.hash == "#skip_intro") {  // This works fine >.<
	generalHTML = '';
}

var div = document.createElement("p");
div.innerHTML = generalHTML;
document.body.appendChild(div);

function addScript(url) {
	var s = document.createElement("script");
	s.type = "text/javascript";
	s.src = url;
	document.getElementsByTagName("head")[0].appendChild(s);
}

// addScript("http://hwi.ath.cx/code/other/gm_scripts/focus/focus.js");

// if (this.console && console.log) {
	// console.log("script elements = "+document.getElementsByTagName("script").length);
// }

/* XHR */

if (this.XMLHttpRequest) {

	function once(f) {
		var done = false;
		return function() {
			if (!done) {
				f();
				done = true;
			}
		};
	}

	function gotIt() {
		// alert("Got responseText: "+req.responseText);
		//while (document.body.firstChild) {
			//document.body.removeChild(document.body.firstChild);
		//}

		var div = document.createElement("div");
		div.innerHTML = req.responseText;
		while (div.childNodes.length) {
			document.body.appendChild(div.childNodes[0]);
		}
		setTimeout(function(){
			addScript("http://hwi.ath.cx/code/other/gm_scripts/make_bookmarklet_from_us/make_bookmarklet_from_us.user.js?dummy="+Math.random());
			// addScript("http://hwi.ath.cx/javascript/focus.js");
			//// This is slow, so let's run it a bit later...
			setTimeout(function(){
				addScript("http://hwi.ath.cx/code/other/gm_scripts/Convert_Dates_to_Ages/Convert_Dates_to_Ages.user.js?dummy="+Math.random());
			},2000);
		},100);
	}

	var gotItOnce = once(gotIt);

	var req = new XMLHttpRequest();

	// Adopt current query params, or default to most-recent-at-top
	// Old: var query = ( document.location.search ? document.location.search : "?M=D" );
	var query = ( document.location.search ? document.location.search : "?C=M;O=D" );

	// Avoid caching (don't think this has ever been needed)
	// query += "&dummy="+new Date().getTime();

	var sync = true;
	// false (non-synchronized) fails in FF 3.5.15 and Konq 3.5.10

	req.open("GET", "http://hwi.ath.cx/code/other/gm_scripts/"+query, sync);
	req.send(null);

	// if (sync) {
		// If we are doing synchronized, then we must call gotIt manually:
		// gotIt();
		// setTimeout(gotIt,1);
	// }

	// Otherwise we act on callback:
	req.onreadystatechange = function (aEvt) {
		if (req.readyState == 4) {
			if(req.status == 200) {
				gotItOnce(req);
			} else {
				alert("XHR failed with status "+req.status+"\n");
			}
		}
	};

	// document.body.appendChild(document.createTextNode("Loading..."));

} else {
	alert("This page requires XMLHttpRequest.");
}

	</script>

	<!-- Still too early <script type="text/javascript" src="http://hwi.ath.cx/code/other/gm_scripts/make_bookmarklet_from_us/make_bookmarklet_from_us.user.js"></script> -->

</BODY></HTML>

