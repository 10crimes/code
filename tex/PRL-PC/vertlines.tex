
\section{Locating the Vertical Vanishing Point} \label{sec-vertvanish}


In a non-fronto-parallel view of a document under perspective, the spacing between adjacent lines of text in the image will vary relative to their distance from the camera.  This is the same effect that causes the railway sleepers beneath a train track to appear closer together as they approach the horizon. This change in spacing can be used to determine the angle at which the document is tilted, and hence the vertical vanishing point of the text plane.

After first transforming the image to simplify the problem, we will extract observations of the altitude of each line in the image.  A model of the geometry will allow us to express these observations as a function of the paragraph's orientation.  By fitting the observations to the function, we will obtain the desired parameters of the orientation.  We show that a higher-order fitting function can assist in avoiding outliers.

An appropriate rotation of the image plane about the z-axis will position the baseline vertically, as shown in \reffig{zyspacings}.  Henceforth we may disregard the $x$-coordinates and deal solely in the $y,z$ plane.
In the model, the bottom of the paragraph is positioned at $\myvec{P}$ with lines occurring at even spacings of distance $\myvec{Q}$.  Therefore the $n$th line from the bottom of the paragraph will appear at:

\begin{figure}[t]
\centering
\begin{center}
  % \epsfig{figure=kkkzyspacings7.eps,width=85mm} %% JOEY, copy this file to your images directory to overwrite the original
  \epsfig{figure=images/zyspacings9.eps,width=110mm}
\caption{The geometry involved in line spacings.}
\label{zyspacings}
\end{center}
\end{figure}

\begin{eqnarray}
\myvec{L}(n) = \myvec{P}+n\myvec{Q} \label{nthline}
\end{eqnarray}

{\parindent 0mm
Now using simple perspective projection ratios, we have: 
%and will project to the point in the image plane
}
%\begin{eqnarray}
%y(n) = f \frac{ \myvec{L}(n)_y }{ \myvec{L}(n)_z } = f \frac{ \myvec{P}_y + n \myvec{Q}_y }{ \myvec{P}_z + n\myvec{Q}_z } \label{spacingspq}
%\end{eqnarray}

\begin{eqnarray}
\frac{y(n)}{f}  = \frac{ \myvec{L}(n)_y }{ \myvec{L}(n)_z }  \label{spacingspq1}
\end{eqnarray}
{\parindent 0mm
where $f$ is the focal length of the camera. Hence, the perspective projection
of the  $n$th line in the image plane, after substituting \refeqn{nthline} into
\refeqn{spacingspq1}, is: 
}
\begin{eqnarray}
y(n) =  f \frac{ \myvec{P}_y + n \myvec{Q}_y }{ \myvec{P}_z + n\myvec{Q}_z } \label{spacingspq}
\end{eqnarray}

{\parindent 0mm
Without losing the nature of the projection, we may scale the scene about the focal point in order to set $\myvec{P}_z$ to $f$, hence modelling the paragraph as if it touched the image plane.  In this case, $\myvec{P}_y=y(0)$,
and we may rewrite \refeqn{spacingspq} as:
}

\begin{eqnarray}
y(n) = U \frac{ 1 + nV }{ 1 + nW } \label{spacingsvweqn}
\end{eqnarray}

{ \parindent 0mm
with $U=y(0)$ and only two unknowns,
$V = {\myvec{Q}_y}/{\myvec{P}_y}$ and $W = {\myvec{Q}_z}/{\myvec{P}_z}$.
The cancelling of the focal length $f$ in this way means that the technique is applicable to images captured with any optical camera and the internal parameters of the original camera need not be known.

To extract approximations of $y(n)$ from the image, we project the centroid of each detected line of text onto the baseline (y-axis), and obtain a set observations $O(n)$.
% By projecting the centroids of the lines of text located in the image from the horizontal vanishing point onto the baseline, estimates for $y(n)$ may be obtained.  % for these points.
A least-squares fit of $O(n)$ to the function $y(n)$ should now yield values for $V$ and $W$, and hence the orientation of the paragraph.
However, since it is common for documents to also contain lines of text which are not part of an evenly spaced paragraph, and for extraneous elements to enter the data, the $n$th line observed in the image may lose correspondence with the $n$th line in the paragraph model.
% For example, an outlier at position $n=K$ would cause all successive observations 
% When fitting the curve of $y(n)$ against $n$, one such outlier at $n=K$ would cause all succesive observations ($n>K$) to have 
In the presence of such outliers, fitting a set of points $(n,O(n))$ to the curve $(n,y(n))$ 
is problematic, since any outlier will break the correspondence between the $x$
and $y$ coordinates of successive points.
% in the presence of outliers is problematic, since we cannot guarantee the linkage of all the point's x and y coordinates.
% To fit a curve of position $y(n)$ against line number $n$ would be unwise in this situation.
% An alternative curve which may be taken from the data and remains unaffected by line number, is the ratio of 
% Fortunately it is possible to derive two $n$-invariant observations from the image which
% To prevent the progression of an outlier through successive observations, we must use 
It is therefore preferable to remove the direct dependence of the points on $n$
by instead fitting the curve of {\em line spacing} $Y_n$ against {\em position} $X_n$, defined as:

\begin{eqnarray}
Y_n = y(n+1)-y(n) & \mbox{~~~~~~~~~~~~~~~line spacing} \label{linespacingsdefneqn} \\
X_n = y(n) & \mbox{~~~~~~~~~~~~~~~line position} \label{linepositiondefneqn}
\end{eqnarray}

In this case any odd lines will appear as isolated outliers with an incorrect line spacing, but the error will not propagate through the remaining $X_n$. % points.
By substituing \refeqn{spacingsvweqn} into the definition of line spacing \refeqn{linespacingsdefneqn}, the curve of $Y$ in terms of $X$ may be written in two parts:
}

\begin{equation}
Y(X) = U \frac{1+(n(X)+1)V}{1+(n(X)+1)W} - U \frac{1+n(X)V}{1+n(X)W}
\label{fittingeqn}
\end{equation}

{\parindent 0mm
with $n$ in terms of $X$ derived by a similar substitution of \refeqn{spacingsvweqn} into the definition of line position \refeqn{linepositiondefneqn} and rearranging to:
}

\begin{equation}
n(X) = \frac{X-U}{UV-XW}
\label{nfromxeqn}
\end{equation}

Initial parameters $V$ and $W$ are chosen for line fitting using a simple estimate. % for the error optimisation.
However, due to the complexity of \refeqn{fittingeqn} and \refeqn{nfromxeqn}, many false minima exist, and one of these may be converged upon during optimisation.
Therefore, to refine the parameters, an initial fit is made with an approximation of \refeqn{fittingeqn}:

\begin{equation}
Y(X) = \frac{ UV }{ 1+n(X)W }
\end{equation}

This ensures that parameters close to the desired minima are obtained before the final fitting.  Once optimised, $V$ and $W$ are plugged into \refeqn{spacingsvweqn} to find the altitude of the horizon $y(\infty) = UV/W$.
% A graph of the final fitting for the running example is shown in \reffig{fittinggraph}.
After reversing the transformation made earlier to bring the baseline upright, this point will correspond to the location of the vertical vanishing point in the original image.
% We therefore fit the measured positions against spacing $(y(n),y(n+1)-y(n))$ to the model:

% \begin{figure}[t]
% \begin{centering}
% \epsfig{figure=images/prlrunning/gplfit.ps,width=75mm}
% \caption{The final fitting of \refeqn{fittingeqn} to the observed line spacing.}
% \label{fittinggraph}
% \end{centering}
% \end{figure}

\reffig{vvpaccuracy} shows the accuracy of recovery of the vertical vanishing
point for the whole range of $0$ to $90^\circ$ in yaw and pitch using the
methods described.  In \reffig{vvpaccuracya} it can be seen that, as expected,
intersecting the left and right margins of a fully justified paragraph gives a
good estimate of the vertical vanishing point.  Also as expected and can be
observed in \reffig{vvpaccuracyb}, when margins are used to estimate the
vertical vanishing point of a non-fully formatted paragraph (in this example a
left-justified one), performance is poor due to the paragraph's jagged edge.
%As with the horizontal vanishing point, the method is not suited to situations
%when the vertical vanishing point is close to infinity, which occurs when the
%pitch is low.
Finally, \reffig{vvpaccuracyc} shows an example of the accuracy when the line
spacings are employed on left-justified paragraphs. This method provides good
results comparable to the first for all of the simulated images except those
documents oriented beyond $80^\circ$ in pitch, where the algorithm begins to
fail.
% The method provides comparable results over most of the simulated images, however for documents beyond $80^\circ$ in pitch the algorithm begins to fail.
As with the horizontal vanishing point in \refsect{locatehvpsect}, this may be
explained by the orientation of the document becoming nearly perpendicular to
the image plane. At such an extreme tilt, even if the lines of text are
separated correctly, their proximity in the image means there is little accuracy
in position and spacing for the curve fitting. In real world images, documents
at such extreme angles cannot practically be read or used by OCR once recovered,
hence this failure is not a great concern. The advantage of the line spacings
method is that it provides consistent results for paragraphs which are not fully
justified.
% In contrast, the poor performance of the margins method when dealing with documents which are not fully justified can be seen in \reffig{vvpaccuracyc}.

% \begin{figure}[t]
% \begin{centering}
  % \subfigure[VVP recovery on fully justified paragraphs by intersecting margins]{\epsfig{figure=images/accuracy-vvp-margins,width=42mm}\label{vvpaccuracya}}
  % \hspace{2mm}
  % \subfigure[Margin intersection fails on left justified paragraphs]{\epsfig{figure=images/accuracy-vvp-margins-jagged.ps,width=42mm}\label{vvpaccuracyb}}
  % \hspace{2mm}
  % \subfigure[VVP recovery on left justified paragraphs by fitting line spacings]{\epsfig{figure=images/accuracy-vvp-spacings-jagged.ps,width=42mm}\label{vvpaccuracyc}}
% \caption{Accuracy of recovery of vertical vanishing point (VVP) on simulated paragraphs at various orientations.}
% \label{vvpaccuracy}
% \end{centering}
% \end{figure}

\begin{figure}[t]
\begin{centering}
  \subfigure[VVP recovery on fully justified paragraphs by intersecting margins]{\epsfig{figure=images/accuracy-vvp-margins,width=60mm}\label{vvpaccuracya}}
  \hspace{2mm}
  \subfigure[Margin intersection fails on left justified paragraphs]{\epsfig{figure=images/accuracy-vvp-margins-jagged.ps,width=60mm}\label{vvpaccuracyb}}
  \hspace{2mm}
  \subfigure[VVP recovery on left justified paragraphs by fitting line spacings]{\epsfig{figure=images/accuracy-vvp-spacings-jagged.ps,width=60mm}\label{vvpaccuracyc}}
  \hspace{2mm}
  \subfigure[VVP recovery on centrally justified paragraphs using line spacings]{\epsfig{figure=images/accuracy-vvp-spacings-jagged.ps,width=60mm}\label{vvpaccuracyd}}
\caption{Accuracy of recovery of vertical vanishing point (VVP) on simulated paragraphs at various orientations.}
\label{vvpaccuracy}
\end{centering}
\end{figure}

The results for these experiments, and the location of the horizontal vanishing
point in \refsect{locatehvpsect}, are shown numerically in
\reftab{accuracytable}. 
The vanishing point (VP) error is calculated as the relative distance of the
vanishing point from its ground truth, as described in \refsect{locatehvpsect}. 
The angular error is derived from the final determined orientation of the
horizontal and vertical vectors of the text plane. 
It can be seen that the accuracy of location of the vertical vanishing point in
reasonable for both the margin intersection and the line spacings method. 
As the last row of \reftab{accuracytable} shows, intersecting margins is not
suitable for documents with jagged edges.

\begin{table}[t]
  \begin{center}
    % \begin{tabular}{|p{2.5in}|l|l|}
    \begin{tabular}{|p{95mm}|l|l|}
      \hline
      {\bf Paragraph (pgh) types } & {\bf VP} & {\bf Angular} \\
      {\bf } & {\bf error} & {\bf error} \\  \hline \hline
      % HVP using projection profiles & 0.129 & 2.16$^\circ$ \\  \hline
      % VVP using margin intersection for fully formatted pghs & 0.0785 & 2.08$^\circ$ \\ \hline
      % VVP using line spacings on what? left? & 0.133 & 3.30$^\circ$ \\ \hline
      % VVP using margin intersection on left formatted pghs & 1.23 & 24.50$^\circ$ \\   \hline
      % VVP using margin intersection on right formatted pghs & X &  XX$^\circ$ \\ \hline
      % VVP using margin intersection on centre formatted pghs & X  &  XX$^\circ$ \\ \hline  \hline
      HVP using projection profiles & 0.129 & 2.16$^\circ$ \\  \hline
      VVP using margin intersection for fully justified pghs & 0.105 & ...$^\circ$ \\ \hline
      VVP using line spacings for fully justified pghs & 0.211 & ...$^\circ$ \\ \hline
      VVP using line spacings for centrally justified pghs & 0.147 & ...$^\circ$ \\ \hline
      VVP using line spacings for left justified pghs & 0.233 & ...$^\circ$ \\ \hline
      VVP using margin intersection on left justified pghs & 0.209 & ...$^\circ$ \\   \hline
      VVP using margin intersection on centrally justified pghs & 0.283 & ...$^\circ$ \\ \hline  \hline
   \end{tabular}
  \end{center}
  % \vspace*{-5mm}
  \caption{Average error for the various methods over $10^\circ$ to $80^{\circ}$ in yaw and pitch.}
  \label{accuracytable}
\end{table}


%% Joey's original table
%\begin{table}[t]
%  \begin{center}
%    % \begin{tabular}{|p{2.5in}|l|l|}
%    \begin{tabular}{|p{8cm}|r@{}l|r@{}l|}
%      \hline
%      {\bf Paragraph (pgh) types } & \multicolumn{2}{c|}{\bf VP} & \multicolumn{2}{c|}{\bf Angular} \\
%      {\bf } & \multicolumn{2}{c|}{\bf error} & \multicolumn{2}{c|}{\bf error} \\  \hline \hline
%      HVP using projection profiles & ~~~0&.129 & ~~~2&.16$^\circ$ \\  \hline
%      VVP using margin intersection for fully formatted pghs & 0&.0785 & 2&.08$^\circ$ \\ \hline
%      VVP using line spacings on what? left? & 0&.133 & 3&.30$^\circ$ \\ \hline
%      VVP using margin intersection on left formatted pghs & 1&.23 & 24&.5$^\circ$ \\   \hline
%      VVP using margin intersection on right formatted pghs & X & &  & XX$^\circ$ \\ \hline
%      VVP using margin intersection on centre formatted pghs & X & & &  XX$^\circ$ \\ \hline  \hline
%   \end{tabular}
%  \end{center}
%  % \vspace*{-5mm}
%  \caption{Average error for the various methods over $10^\circ$ to $80^{\circ}$ in yaw and pitch.}
%  \label{accuracytable}
%\end{table}



Having found the vanishing points of the plane, we may project two lines from each
to describe the left and right margins and the top and bottom limits of the paragraph.
These lines are intersected to form a quadrilateral enclosing the text,
as shown in \reffig{summaryfig}. % , which is expanded to frame the paragraph.
This quadrilateral is then used to recover a fronto-parallel viewpoint
of the paragraph of text.





\include{quadrecovery}





\begin{figure}[t]
\centering
\begin{center}
% \epsfig{figure=images/image29001recover.ps,width=60mm}
% \epsfig{figure=images/chem002001recover.ps,height=54mm}
% \hspace{2mm}
% \epsfig{figure=images/chem010recover.ps,height=54mm}
% \subfigure[Recovery of running example]{\epsfig{figure=images/chem002001recover.ps,height=52mm}}
\subfigure[Recovery of running example]{\epsfig{figure=images/prlrunning/recover.eps,height=52mm}}
\hspace{2mm}
% \subfigure[Recovery of paragraph in \reffig{chem015overlay}, suitable for OCR.]{
	% % \epsfig{figure=images/chem010recover.ps,height=52mm}\label{arthurcclarke}
	% \epsfig{figure=images/prlall/chem015/recover.eps,height=52mm}\label{chem015recover}
% }
\subfigure[Recovery of paragraph from \reffig{chem015overlay}, suitable for OCR.]{
	\epsfig{figure=images/prlall/chem015/recover.eps,height=52mm}\label{chem015recover}
}
\subfigure[Recovery of second paragraph from \reffig{chem015overlay}.]{
	\epsfig{figure=images/prlall/chem015/recover-other.eps,height=52mm}\label{chem015recoverother}
}
\end{center}
%\vspace{-3mm}
\caption{Fronto-parallel recovery of example documents in \reffig{summaryfig}.}
\label{pprecover}
\end{figure}




\begin{figure}
\centering
\begin{center}

\subfigure[]{ \begin{tabular}{c}
	\epsfig{figure=images/chem010overlay.ps,width=36mm} \\
		$\downarrow$ \\
		\vspace{-4.5mm}
		\\
		\epsfig{figure=images/chem010recover.ps,width=36mm}
	\end{tabular}       \label{arthurcclarke}
	\label{empprb}
}
\subfigure[]{ \begin{tabular}{c}
	\includegraphics[width=36mm]{images/chem008oo.ps}   \\
		$\downarrow$ \\
		\vspace{-4.5mm}
		\\
		\includegraphics[width=36mm]{images/chem008001recover.ps}   \\
		\includegraphics[width=36mm]{images/chem008002recover.ps}
	\end{tabular} \label{emppre}
}
\subfigure[]{ \begin{tabular}{c}
	\epsfig{figure=images/chem011.ps,width=36mm}\label{banana} \\
		$\downarrow$ \\
		\vspace{-4.5mm}
		\\
		\epsfig{figure=images/chem011recover.ps,width=30mm}
	\end{tabular}       \label{emppra}
}
% \\ \vspace{-3mm}
\\ \vspace{5mm}
\subfigure[]{ \begin{tabular}{c}
	\includegraphics[width=36mm]{images/chem006oo.ps} \\
		$\downarrow$ \\
		\vspace{-4.5mm}
		\\
		\includegraphics[width=36mm]{images/chem006002recover.ps}
	\end{tabular}      \label{empprd}
}
\subfigure[]{ \begin{tabular}{c}
	\includegraphics[width=36mm]{images/clut4allover.ps}       \\
		$\downarrow$ \\
		\vspace{-4.5mm}
		\\
		\includegraphics[width=36mm]{images/clut4recover1.ps}    \\
		\includegraphics[width=36mm]{images/clut4recover2.ps}
	\end{tabular} \label{empprf}
}
\subfigure[]{ \begin{tabular}{c}
	\epsfig{figure=images/chem005001origover.ps,width=36mm} \\
		$\downarrow$ \\
		\vspace{-4.5mm}
		\\
		\epsfig{figure=images/chem005001recover.ps,width=36mm}
	\end{tabular}       \label{chem005recover}
	% \label{empprb}
}
% \subfigure[]{ \begin{tabular}{c}
	% \epsfig{figure=images/dv5.ps,width=36mm} \\
		% $\downarrow$ \\
		% \\
		% % \hspace{11mm}
	% % \put(10,38){$\rightarrow$}
	% % \hspace{11mm}
	% \epsfig{figure=images/dv5recover.ps,width=24mm}
	% \end{tabular}      \label{empprc}
	% }
	% \subfigure[]{ \begin{tabular}{c}
		% \epsfig{figure=images/dv5.ps,width=36mm} \\
			% $\downarrow$ \\
			% \\
			% \epsfig{figure=images/dv5recover.ps,width=36mm}
		% \end{tabular}      \label{empprc}
		% }
		% \subfigure[]{ \begin{tabular}{c}
			% \includegraphics[width=36mm]{images/clut4allover.ps}       \\
				% $\downarrow$ \\
				% \\
				% \includegraphics[width=36mm]{images/clut4recover1.ps}    \\
				% \includegraphics[width=36mm]{images/clut4recover2.ps}
			% \end{tabular} \label{empprf} }
% \hspace{2mm}

%%% Note some other good images:
% chem010 001
% chem017 001
% chem004 001-3
% chem022 001
% chem026 001 strong persp + OCR!

\end{center}
\caption{Further examples of fronto-parallel recovery of documents. In each case the original image is shown above the recovered output.}
\label{againmoreppresults}
\end{figure}

%% JOEY USE FIG6b as a new example in Figure 10.
\reffig{pprecover} shows the rectified images of the examples in
\reffig{linesegfig}. 
Further examples in \reffig{againmoreppresults}
show the recovery of different styles of paragraphs with left justified and
centrally aligned text.
\reffig{emppra} shows the recovery of a segmented region of a book cover.  Despite 
text of different sizes, and other image noise such as the specularity, the document is recovered robustly.
\reffig{arthurcclarke} shows a centrally justified paragraph which has been recovered at high resolution and is easily readable.
% In \reffig{empprc} a left justified document was correctly identified and recovered, despite occlusion of part of the paragraph.
When we applied commercial OCR software to the image in \reffig{arthurcclarke},
81\% of the characters and 84\% of the words were recognised correctly.


\begin{table}[t]
  \begin{center}
    % \begin{tabular}{|p{95mm}|l|l|}
    \begin{tabular}{|p{35mm}|c|c|}
      \hline
      {\bf Image } & {\bf \%age correct characters} & {\bf \%age correct words} \\
      \hline \hline
      \reffig{chem015recover} & 79\% & 88\% \\
      \hline
      \reffig{arthurcclarke} & 81\% & 84\% \\
      \hline
      \reffig{chem005recover} & 50\% & 53\% \\
		\hline  \hline
   \end{tabular}
  \end{center}
  % \vspace*{-5mm}
  \caption{Accuracy of Optical Character Recognition for recovered images.}
  \label{ocrtable}
\end{table}

