
\section{Locating the Vertical Vanishing Point} \label{sec-vertvanish}


In a perspective, non-fronto-parallel view, the spacings between adjacent lines
of text in an image will vary relative to their distance from the camera.  These
appear closer together as they approach the horizon, much like the sleepers
beneath railway tracks. This change in spacing can be used to determine the angle
at which the document is tilted, and hence the vertical vanishing point of the
text plane.

By rotating the image plane to place the baseline vertically, we may disregard the $x$-coordinates and deal solely in the $y,z$ plane, as shown in \reffig{zyspacings}.
Here, the bottom of the paragraph is positioned at $\myvec{P}$ with lines occurring at even spacings of distance $\myvec{Q}$.  Therefore the $n$th line from the bottom of the paragraph will appear at:

\begin{figure}[t]
\centering
\begin{center}
  \epsfig{figure=kkkzyspacings7.eps,width=85mm} %% JOEY, copy this file to your images directory to overwrite the original
\caption{The geometry involved in line spacings.}
\label{zyspacings}
\end{center}
\end{figure}

\begin{eqnarray}
\myvec{L}(n) = \myvec{P}+n\myvec{Q} \label{nthline}
\end{eqnarray}

{\parindent 0mm
Now using simple perspective projection ratios, we have: 
%and will project to the point in the image plane
}
%\begin{eqnarray}
%y(n) = f \frac{ \myvec{L}(n)_y }{ \myvec{L}(n)_z } = f \frac{ \myvec{P}_y + n \myvec{Q}_y }{ \myvec{P}_z + n\myvec{Q}_z } \label{spacingspq}
%\end{eqnarray}

\begin{eqnarray}
\frac{y(n)}{f}  = \frac{ \myvec{L}(n)_y }{ \myvec{L}(n)_z }  \label{spacingspq1}
\end{eqnarray}
{\parindent 0mm
where $f$ is the focal length of the camera. Hence, the perspective projection
of the  $n$th line in the image plane after replacing from (\ref{nthline}) into
(\ref{spacingspq1}) is: 
}
\begin{eqnarray}
y(n) =  f \frac{ \myvec{P}_y + n \myvec{Q}_y }{ \myvec{P}_z + n\myvec{Q}_z } \label{spacingspq}
\end{eqnarray}

{\parindent 0mm
Without losing the nature of the projection, we may scale the scene about the focal point in order to set $\myvec{P}_z$ to $f$, hence modelling the paragraph as if it touched the image plane.  In this case, $\myvec{P}_y=y(0)$,
and we may rewrite \refeqn{spacingspq} as:
}

\begin{eqnarray}
y(n) = U \frac{ 1 + nV }{ 1 + nW } \label{spacingsvweqn}
\end{eqnarray}

{ \parindent 0mm
with $U=y(0)$ and only two unknowns,
$V = {\myvec{Q}_y}/{\myvec{P}_y}$ and $W = {\myvec{Q}_z}/{\myvec{P}_z}$.
The cancelling of the focal length $f$ in this way means that the technique is
applicable to images captured with any optical camera and the internal
parameters of the original camera need not be known.
By projecting the centroids of the lines of text located in the image from the horizontal vanishing point onto the baseline, estimates for $y(n)$ may be obtained.
% for these points.
However, since it is common for documents to also contain lines of text which are not part of an evenly spaced paragraph, and for extraneous elements to enter the data, the $n$th line found in the image may lose correspondence with the $n$th line in the paragraph model.
To fit a curve of position $y(n)$ against line number $n$ would be unwise in this situation.
It is therefore preferable to fit the curve of {\em line spacing} $Y_n$
against {\em position} $X_n$, defined as:

\begin{eqnarray}
Y_n=y(n+1)-y(n) \label{linespacingsdefneqn} \\
X_n=y(n) \label{linepositiondefneqn}
\end{eqnarray}

In this case any odd lines will appear as isolated outliers in line spacing, but will not propagate through the remaining points.
By substituing \refeqn{spacingsvweqn} into the definition of line spacing \refeqn{linespacingsdefneqn}, the curve of $Y$ in terms of $X$ may be written in two parts:
}

\begin{equation}
Y(X) = U ( \frac{1+(n(X)+1)V}{1+(n(X)+1)W} - \frac{1+n(X)V}{1+n(X)W} )
\label{fittingeqn}
\end{equation}

{\parindent 0mm
with $n(X)$ derived by a similar substitution of \refeqn{spacingsvweqn} into the definition of line position \refeqn{linepositiondefneqn} and rearranging to:
}

\begin{equation}
n(X) = \frac{X-U}{XW-UV}
\label{nfromxeqn}
\end{equation}

Initial parameters $V$ and $W$ are chosen for line fitting using a simple estimate for the error optimisation.
However, due to the complexity of \ref{fittingeqn} and \ref{nfromxeqn}, many false minima exist, and one of these may be converged upon during optimisation.
Therefore, to refine the parameters, an initial fit is made with an approximation of \refeqn{fittingeqn}:

\begin{equation}
Y(X) = \frac{ UV }{ 1+n(X)W }
\end{equation}

This ensures that parameters close to the desired minima are obtained before the final fitting.  Once optimised, $V$ and $W$ are plugged into \refeqn{spacingsvweqn} to find the altitude of the horizon $y(\infty) = UV/W$.
By reversing the rotation made earlier to bring the baseline upright, this point will correspond to the location of the vertical vanishing point in the original image.
% We therefore fit the measured positions against spacing $(y(n),y(n+1)-y(n))$ to the model:

\begin{figure}[t]
\begin{centering}
  \subfigure[VVP recovery on fully justified paragraphs by intersecting margins]{\epsfig{figure=images/accuracy-vvp-margins,width=40mm}\label{vvpaccuracya}}
	\hspace{2mm}
  \subfigure[Margin intersection fails on left justified paragraphs]{\epsfig{figure=images/accuracy-vvp-margins-jagged.ps,width=40mm}\label{vvpaccuracyb}}
  \subfigure[VVP recovery on left justified paragraphs by fitting line spacings]{\epsfig{figure=images/accuracy-vvp-spacings-jagged.ps,width=40mm}\label{vvpaccuracyc}}
\caption{Accuracy of recovery of vertical vanishing point (VVP) on simulated paragraphs at various orientations.}
\label{vvpaccuracy}
\end{centering}
\end{figure}

\reffig{vvpaccuracy} shows the accuracy of recovery of the vertical vanishing
point for the whole range of $0$ to $90^\circ$ in yaw and pitch using the
methods described.  In \reffig{vvpaccuracya} it can be seen that, as expected,
intersecting the left and right margins of a fully justified paragraph gives a
good estimate of the vertical vanishing point.  Also as expected and can be
observed in \reffig{vvpaccuracyb}, when margins are used to estimate the
vertical vanishing point of a non-fully formatted paragraph (in this example a
left-justified one), performance is poor due to the paragraph's jagged edge.
%As with the horizontal vanishing point, the method is not suited to situations
%when the vertical vanishing point is close to infinity, which occurs when the
%pitch is low.
Finally, \reffig{vvpaccuracyc} shows an example of the accuracy when the line
spacings are employed on left-justified paragraphs. This method provides good
results comparable to the first for all of the simulated images except those
documents oriented beyond $80^\circ$ in pitch, where the algorithm begins to
fail.
% The method provides comparable results over most of the simulated images, however for documents beyond $80^\circ$ in pitch the algorithm begins to fail.
As with the horizontal vanishing point in \refsect{locatehvpsect}, this may be
explained by the orientation of the document becoming nearly perpendicular to
the image plane. At such an extreme tilt, even if the lines of text are
separated correctly, their proximity in the image means there is little accuracy
in position and spacing for the curve fitting. In real world images, documents
at such extreme angles cannot practically be read or used by OCR once recovered,
hence this failure is not a great concern. The advantage of the line spacings
method is that it provides consistent results for paragraphs which are not fully
justified.
% In contrast, the poor performance of the margins method when dealing with documents which are not fully justified can be seen in \reffig{vvpaccuracyc}.

The results for these experiments, and the location of the horizontal vanishing
point in \refsect{locatehvpsect}, are shown numerically in
\reftab{accuracytable}. 
The vanishing point (VP) error is calculated as the relative distance of the
vanishing point from its ground truth, as described in \refsect{locatehvpsect}. 
The angular error is derived from the final determined orientation of the
horizontal and vertical vectors of the text plane. 
It can be seen that the accuracy of location of the vertical vanishing point in
reasonable for both the margin intersection and the line spacings method. 
As the last row of \reftab{accuracytable} shows, intersecting margins is not
suitable for documents with jagged edges. 

\begin{table}[t]
  \begin{center}
    % \begin{tabular}{|p{2.5in}|l|l|}
    \begin{tabular}{|p{95mm}|l|l|}
      \hline
      {\bf Paragraph (pgh) types } & {\bf VP} & {\bf Angular} \\
      {\bf } & {\bf error} & {\bf error} \\  \hline \hline
      HVP using projection profiles & 0.129 & 2.16$^\circ$ \\  \hline
      VVP using margin intersection for fully formatted pghs & 0.0785 & 2.08$^\circ$ \\ \hline
      VVP using line spacings on what? left? & 0.133 & 3.30$^\circ$ \\ \hline
      VVP using margin intersection on left formatted pghs & 1.23 & 24.50$^\circ$ \\   \hline
      VVP using margin intersection on right formatted pghs & X &  XX$^\circ$ \\ \hline
      VVP using margin intersection on centre formatted pghs & X  &  XX$^\circ$ \\ \hline  \hline
   \end{tabular}
  \end{center}
  % \vspace*{-5mm}
  \caption{Average error for the various methods over $10^\circ$ to $80^{\circ}$ in yaw and pitch.}
  \label{accuracytable}
\end{table}


%% Joey's original table
%\begin{table}[t]
%  \begin{center}
%    % \begin{tabular}{|p{2.5in}|l|l|}
%    \begin{tabular}{|p{8cm}|r@{}l|r@{}l|}
%      \hline
%      {\bf Paragraph (pgh) types } & \multicolumn{2}{c|}{\bf VP} & \multicolumn{2}{c|}{\bf Angular} \\
%      {\bf } & \multicolumn{2}{c|}{\bf error} & \multicolumn{2}{c|}{\bf error} \\  \hline \hline
%      HVP using projection profiles & ~~~0&.129 & ~~~2&.16$^\circ$ \\  \hline
%      VVP using margin intersection for fully formatted pghs & 0&.0785 & 2&.08$^\circ$ \\ \hline
%      VVP using line spacings on what? left? & 0&.133 & 3&.30$^\circ$ \\ \hline
%      VVP using margin intersection on left formatted pghs & 1&.23 & 24&.5$^\circ$ \\   \hline
%      VVP using margin intersection on right formatted pghs & X & &  & XX$^\circ$ \\ \hline
%      VVP using margin intersection on centre formatted pghs & X & & &  XX$^\circ$ \\ \hline  \hline
%   \end{tabular}
%  \end{center}
%  % \vspace*{-5mm}
%  \caption{Average error for the various methods over $10^\circ$ to $80^{\circ}$ in yaw and pitch.}
%  \label{accuracytable}
%\end{table}













Having found the vanishing points of the plane, we may project two lines from each
to describe the left and right margins and the top and bottom limits of the paragraph.
These lines are intersected to form a quadrilateral enclosing the text,
as shown in \reffig{summaryfig}. % , which is expanded to frame the paragraph.
This quadrilateral is then used to recover a fronto-parallel viewpoint
of the paragraph of text.


\begin{figure}[t]
\centering
\begin{center}
% \epsfig{figure=images/image29001recover.ps,width=60mm}
% \epsfig{figure=images/chem002001recover.ps,height=54mm}
% \hspace{2mm}
% \epsfig{figure=images/chem010recover.ps,height=54mm}
\subfigure[Recovery of running example]{\epsfig{figure=images/chem002001recover.ps,height=52mm}}
\hspace{2mm}
\subfigure[Suitable for OCR]{\epsfig{figure=images/chem010recover.ps,height=52mm}\label{arthurcclarke}}
\end{center}
%\vspace{-3mm}
\caption{Fronto-parallel recovery of example documents in \reffig{summaryfig}.}
\label{pprecover}
\end{figure}




\begin{figure}[t]
\centering
\begin{center}

    \subfigure[]{ \begin{tabular}{c}
      \epsfig{figure=images/chem011.ps,width=33mm}\label{banana} \\
      $\downarrow$ \\
           \\
      \epsfig{figure=images/chem011recover.ps,width=26mm}
        \end{tabular}       \label{emppra}
    }
	 \hspace{2mm}
    \subfigure[]{ \begin{tabular}{c}
      \epsfig{figure=images/chem015.ps,width=36mm} \\
      $\downarrow$ \\
           \\
      \epsfig{figure=images/chem015recover.ps,width=36mm}
        \end{tabular}       \label{empprb}
    }
    \subfigure[]{ \begin{tabular}{c}
      \epsfig{figure=images/dv5.ps,width=36mm}
		\hspace{11mm}
      \put(10,38){$\rightarrow$}
		\hspace{11mm}
      \epsfig{figure=images/dv5recover.ps,width=24mm}
        \end{tabular}      \label{empprc}
     }
    % \subfigure[]{ \begin{tabular}{c}
      % \epsfig{figure=images/dv5.ps,width=36mm} \\
      % $\downarrow$ \\
           % \\
      % \epsfig{figure=images/dv5recover.ps,width=36mm}
        % \end{tabular}      \label{empprc}
     % }
% \\ \vspace{5mm}
    % \subfigure[]{ \begin{tabular}{c}
      % \includegraphics[width=35mm]{images/chem006oo.ps} \\
      % $\downarrow$ \\
          % \\
      % \includegraphics[width=35mm]{images/chem006002recover.ps}
        % \end{tabular}      \label{empprd}
     % }
    % \subfigure[]{ \begin{tabular}{c}
        % \includegraphics[width=35mm]{images/chem008oo.ps}   \\
      % $\downarrow$ \\
          % \\
        % \includegraphics[width=35mm]{images/chem008001recover.ps}   \\
        % \includegraphics[width=35mm]{images/chem008002recover.ps}
    % \end{tabular} \label{emppre} }
    % \subfigure[]{ \begin{tabular}{c}
        % \includegraphics[width=35mm]{images/clut4allover.ps}       \\
      % $\downarrow$ \\
           % \\
        % \includegraphics[width=35mm]{images/clut4recover1.ps}    \\
        % \includegraphics[width=35mm]{images/clut4recover2.ps}
    % \end{tabular} \label{empprf} }

\end{center}
\vspace*{-3mm}
\caption{Further examples of fronto-parallel recovery of documents. In each case the original image is shown above the recovered output.}
\label{againmoreppresults}
\end{figure}

%% JOEY USE FIG6b as a new example in Figure 10.
\reffig{pprecover} shows the rectified images of the examples in
\reffig{linesegfig}. 
Further examples in \reffig{againmoreppresults}
show the recovery of different styles of paragraphs with left justified and
centrally aligned text.
\reffig{emppra} shows the recovery of a segmented region of a book cover.  Despite 
text of different sizes, and other image noise such as the specularity, the document is recovered robustly.
\reffig{empprb} shows a centrally justified paragraph which has been recovered at high resolution and is easily readable.
In \reffig{empprc} a left justified document was correctly identified and recovered, despite occlusion of part of the paragraph.
When we applied commercial OCR software to the image in \reffig{arthurcclarke}, 87\% of the characters and 94\% of the words were recognised correctly.
